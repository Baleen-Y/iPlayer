name: Release

# on:
#   schedule:
#     # * is a special character in YAML so you have to quote this string
#     - cron: "5 * * * *"
on: [push]

jobs:
  release:
    name: Release
    strategy:
      matrix:
        os: [macos-latest, windows-latest]
    runs-on: ${{matrix.os}}

    steps:

      - name: init
        uses: actions/checkout@v1
      
      - name: set node
        uses: actions/setup-node@v2
        with:
          node-version: 16 #lts/*

      - name: clone
        env:
          sha: ${{steps.sha.outputs.value}} 
        run: |
          ls -alF
          rm -rf *
          rm -rf .git
          rm -rf .github
          ls -alF
          git clone -b dev ${{secrets.GIT_ADDRESS}} .
        shell: bash
        
      - name: install
        run: yarn
        
      - name: win
        if: startsWith(matrix.os, 'windows')
        run: npm run app:windows
          
      - name: mac
        if: startsWith(matrix.os, 'macOS')
        run: |
          npm run build:prod
          npm run mac:dmg
          npm run mac:mas

      - name: get package
        id: package
        uses: Ireoo/get-package@v1
        with:
          path: package.json
          key: version

      - name: create release
        id: release
        uses: actions/create-release@v1.0.0
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
        with:
          tag_name: v${{steps.package.outputs.version}}
          release_name: V${{steps.package.outputs.version}}
          draft: false
          prerelease: true

      - name: Upload Release
        uses: Ireoo/upload-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.release.outputs.upload_url }}
          dir: release
          exts: '["exe", "dmg", "zip", "appimage", "deb", "rpm", "apk", "msi", "pkg", "appx", "blockmap", "yml"]'
          suffix: ""
